name: Deploy SpringBoot to Aliyun ECS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉代码
      - uses: actions/checkout@v4

      # 2. 设置 JDK 17（跟你项目一致即可，11/8 改版本号）
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 3.  Maven 打包（Gradle 看下方备注）
      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      # 4. 把生成的 jar 传到服务器
      - name: Upload jar to server
        uses: appleboy/scp-action@v0.1.5
        with:
          host: 120.24.109.29
          username: root
          key: ${{ secrets.PRIVATE_KEY }}
          source: "target/*.jar"
          target: "/root/springboot"
          strip_components: 1   # 去掉 target 目录层

      # 5. 重启服务
      - name: Restart application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 120.24.109.29
          username: root
          key: ${{ secrets.PRIVATE_KEY }}
          command_timeout: 30s   # 显式给 30 秒足够
          script: |
            cd /root/springboot
            pkill -f 'java -jar' || true
            # 启动并立即脱离，不再占用终端
            nohup java -jar *.jar --server.port=9011 > app.log 2>&1 &
            # 给 JVM 1 秒启动时间，再打印一句确保 Actions 认为“有输出”
            sleep 1
            echo "SpringBoot restarted on port 9011"