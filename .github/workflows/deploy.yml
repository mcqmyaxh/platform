name: Deploy SpringBoot to Aliyun ECS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉代码
      - uses: actions/checkout@v4

      # 2. 设置 JDK 21
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 3. Maven 打包
      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      # 4. 把生成的 jar 传到服务器
      - name: Upload jar to server
        uses: appleboy/scp-action@v0.1.5
        with:
          host: 120.24.109.29
          username: root
          key: ${{ secrets.PRIVATE_KEY }}
          source: "target/*.jar"
          target: "/root/springboot"
          strip_components: 1

      # 5. 重启服务（修复版本）
      - name: Restart application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 120.24.109.29
          username: root
          key: ${{ secrets.PRIVATE_KEY }}
          script: |
            cd /root/springboot

            # Kill existing process
            PID=$(lsof -ti:9011)
            [ -n "$PID" ] && (echo "Killing $PID"; kill -9 $PID; sleep 3)

            # Backup log
            [ -f app.log ] && cp app.log "app.log.$(date +%Y%m%d_%H%M%S).bak"

            # Start app with IPv4 preference
            nohup java -Djava.net.preferIPv4Stack=true -jar *.jar --server.port=9011 > app.log 2>&1 &
            echo "Started, waiting 30s..."
            sleep 30

            # Health check using 127.0.0.1
            for i in {1..10}; do
              if curl -f -s http://127.0.0.1:9011/actuator/health >/dev/null; then
                echo "✅ Deploy success!"
                exit 0
              fi
              echo "⏳ Retry $i/10"
              sleep 10
            done

            echo "❌ Health check failed"
            tail -30 app.log
            exit 1