name: Deploy SpringBoot to Aliyun ECS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ‹‰ä»£ç 
      - uses: actions/checkout@v4

      # 2. è®¾ç½® JDK 21
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 3. Maven æ‰“åŒ…
      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      # 4. æŠŠç”Ÿæˆçš„ jar ä¼ åˆ°æœåŠ¡å™¨
      - name: Upload jar to server
        uses: appleboy/scp-action@v0.1.5
        with:
          host: 120.24.109.29
          username: root
          key: ${{ secrets.PRIVATE_KEY }}
          source: "target/*.jar"
          target: "/root/springboot"
          strip_components: 1

      # 5. é‡å¯æœåŠ¡ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
      - name: Restart application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 120.24.109.29
          username: root
          key: ${{ secrets.PRIVATE_KEY }}
          script: |
            cd /root/springboot

            # æ£€æŸ¥å¹¶æ€æ­»ç°æœ‰è¿›ç¨‹
            echo "Checking for existing process on port 9011..."
            PID=$(lsof -ti:9011 || echo "")
            if [ -n "$PID" ]; then
              echo "Killing existing process: $PID"
              kill -9 $PID
              sleep 3
            else
              echo "No existing process found on port 9011"
            fi

            # å¤‡ä»½æ—§æ—¥å¿—
            if [ -f app.log ]; then
              cp app.log "app.log.$(date +%Y%m%d_%H%M%S).bak"
            fi

            # å¯åŠ¨æ–°è¿›ç¨‹ï¼ˆå¼ºåˆ¶ä½¿ç”¨ IPv4ï¼‰
            echo "Starting new SpringBoot application..."
            nohup java -Djava.net.preferIPv4Stack=true -jar *.jar --server.port=9011 > app.log 2>&1 &
            START_PID=$!

            # ç­‰å¾…åº”ç”¨åˆå§‹åŒ–
            echo "Waiting for application to start..."
            sleep 30

            # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦ä»åœ¨è¿è¡Œ
            if ! kill -0 $START_PID 2>/dev/null; then
              echo "âŒ Java process crashed after startup!"
              echo "=== Last 50 lines of app.log ==="
              tail -50 app.log || echo "No log file found"
              exit 1
            fi

            # æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
            NEW_PID=$(lsof -ti:9011 || echo "")
            if [ -z "$NEW_PID" ]; then
              echo "âŒ No process found listening on port 9011"
              echo "=== Last 50 lines of app.log ==="
              tail -50 app.log || echo "No log file found"
              exit 1
            fi

            echo "âœ… SpringBoot restarted successfully on port 9011 (PID: $NEW_PID)"

            # å¥åº·æ£€æŸ¥ï¼ˆä½¿ç”¨ 127.0.0.1 é¿å… localhost è§£æé—®é¢˜ï¼‰
            echo "Performing health check..."
            for i in {1..10}; do
              if curl -f -s http://127.0.0.1:9011/actuator/health > /dev/null 2>&1; then
                echo "âœ… Health check passed!"
                echo "ğŸ“ Log file: /root/springboot/app.log"
                echo "ğŸŒ Application URL: http://120.24.109.29:9011"
                exit 0  # æˆåŠŸé€€å‡º
              else
                echo "â³ Waiting for application to be ready... ($i/10)"
                sleep 10
              fi
            done

            # æœ€ç»ˆå¤±è´¥å¤„ç†
            echo "âŒ Health check failed after multiple attempts"
            echo "=== Last 50 lines of app.log ==="
            tail -50 app.log || echo "No log file found"
            exit 1